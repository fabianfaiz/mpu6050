<!DOCTYPE html>
<html>
<head>
  <title>Deteksi Kemiringan Ruangan</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
</head>
<body>

<h3>Kemiringan Ruangan</h3>
<p id="angle">0°</p>

<button onclick="saveRight()">Simpan Samping Kanan</button>
<button onclick="saveBottom()">Simpan Bawah</button>

<div id="views"></div>

<script>
const ESP32_IP = "http://192.168.1.6";

let savedRight = null;
let savedBottom = null;

// ====== SCENE ======
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, 600 / 300, 0.1, 1000);
let renderer = new THREE.WebGLRenderer();
renderer.setSize(600, 300);
document.body.appendChild(renderer.domElement);

// LIVE cube
let liveCube = createCube(0x00ff00);
scene.add(liveCube);

// Saved cubes
let rightCube = null;
let bottomCube = null;
let combinedCube = null;

camera.position.z = 7;

function createCube() {
  let geometry = new THREE.BoxGeometry(2, 0.3, 2);
  let material = new THREE.MeshNormalMaterial();
  return new THREE.Mesh(geometry, material);
}

// ====== ANIMATE ======
function animate() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      liveCube.rotation.x = data.pitch * Math.PI / 180;
      liveCube.rotation.z = data.roll  * Math.PI / 180;

      updateCombined();
    });

  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

// ====== SAVE FUNCTIONS ======
function saveRight() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      savedRight = data;

      if (rightCube) scene.remove(rightCube);
      rightCube = createCube();
      rightCube.position.x = -3;
      rightCube.rotation.x = data.pitch * Math.PI / 180;
      rightCube.rotation.z = data.roll  * Math.PI / 180;

      scene.add(rightCube);
    });
}

function saveBottom() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      savedBottom = data;

      if (bottomCube) scene.remove(bottomCube);
      bottomCube = createCube();
      bottomCube.position.x = 3;
      bottomCube.rotation.x = data.pitch * Math.PI / 180;
      bottomCube.rotation.z = data.roll  * Math.PI / 180;

      scene.add(bottomCube);
    });
}

// ====== COMBINE & HITUNG SUDUT ======
function updateCombined() {
  if (!savedRight || !savedBottom) return;

  let pitch = (savedRight.pitch + savedBottom.pitch) / 2;
  let roll  = (savedRight.roll  + savedBottom.roll)  / 2;

  if (combinedCube) scene.remove(combinedCube);
  combinedCube = createCube();
  combinedCube.position.y = -2;
  combinedCube.rotation.x = pitch * Math.PI / 180;
  combinedCube.rotation.z = roll  * Math.PI / 180;

  scene.add(combinedCube);

  let totalAngle = Math.sqrt(pitch * pitch + roll * roll);
  document.getElementById("angle").innerText =
    totalAngle.toFixed(2) + "°";
}

animate();
</script>

</body>
</html>
