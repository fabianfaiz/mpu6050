<script>
const ESP32_IP = "http://192.168.1.6";

let savedRight = null;
let savedBottom = null;

// ====== CREATE VIEW ======
function createView(container) {
  let scene = new THREE.Scene();
  let camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
  let renderer = new THREE.WebGLRenderer();
  renderer.setSize(200, 200);
  document.getElementById(container).appendChild(renderer.domElement);

  camera.position.set(3, 3, 5);
  camera.lookAt(0, 0, 0);

  return { scene, camera, renderer };
}

// ====== VIEWS ======
let liveView   = createView("live");
let rightView  = createView("right");
let bottomView = createView("bottom");
let combView   = createView("combine");

// ====== LIVE OBJECT ======
let livePlane = new THREE.Mesh(
  new THREE.PlaneGeometry(2, 2),
  new THREE.MeshNormalMaterial({ side: THREE.DoubleSide })
);
liveView.scene.add(livePlane);

// ====== SAVED OBJECTS ======
let rightPlane, bottomPlane;

// ====== LIVE UPDATE ======
function animate() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      // LIVE (ikuti langsung)
      livePlane.rotation.x = data.pitch * Math.PI / 180;
      livePlane.rotation.z = data.roll  * Math.PI / 180;
    });

  renderAll();
  requestAnimationFrame(animate);
}

// ====== SAVE ======
function saveRight() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      savedRight = data;

      if (rightPlane) rightView.scene.remove(rightPlane);
      rightPlane = createVerticalPlane(data.roll);
      rightView.scene.add(rightPlane);

      updateCombine();
    });
}

function saveBottom() {
  fetch(`${ESP32_IP}/data`)
    .then(res => res.json())
    .then(data => {
      savedBottom = data;

      if (bottomPlane) bottomView.scene.remove(bottomPlane);
      bottomPlane = createHorizontalPlane(data.pitch);
      bottomView.scene.add(bottomPlane);

      updateCombine();
    });
}

// ====== PLANE CREATION ======
function createVerticalPlane(roll) {
  let plane = new THREE.Mesh(
    new THREE.PlaneGeometry(2, 2),
    new THREE.MeshNormalMaterial({ side: THREE.DoubleSide })
  );
  plane.rotation.y = Math.PI / 2;     // tegak
  plane.rotation.z = roll * Math.PI / 180;
  return plane;
}

function createHorizontalPlane(pitch) {
  let plane = new THREE.Mesh(
    new THREE.PlaneGeometry(2, 2),
    new THREE.MeshNormalMaterial({ side: THREE.DoubleSide })
  );
  plane.rotation.x = -Math.PI / 2;    // tidur
  plane.rotation.x += pitch * Math.PI / 180;
  return plane;
}

// ====== COMBINE ======
function updateCombine() {
  if (!savedRight || !savedBottom) return;

  combView.scene.clear();

  let wall = createVerticalPlane(savedRight.roll);
  let floor = createHorizontalPlane(savedBottom.pitch);

  wall.position.x = -1;
  floor.position.y = -1;

  combView.scene.add(wall);
  combView.scene.add(floor);

  // Hitung kemiringan ruang (vektor normal lantai)
  let normal = new THREE.Vector3(0, 1, 0)
    .applyEuler(floor.rotation);

  let angle = THREE.MathUtils.radToDeg(
    Math.acos(normal.dot(new THREE.Vector3(0, 1, 0)))
  );

  document.getElementById("angle").innerText =
    angle.toFixed(2) + "Â°";
}

// ====== RENDER ======
function renderAll() {
  [liveView, rightView, bottomView, combView].forEach(v => {
    v.renderer.render(v.scene, v.camera);
  });
}

animate();
</script>

